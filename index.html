<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Expense Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --matcha: #8fc7a4;
  --matcha-dark: #669e7c; 
  --matcha-light: #e8f5e9;
  --strawberry: #f48fb1;
  --strawberry-hover: #ec7aa0;
  --strawberry-dark: #d81b60;
  --strawberry-light: #fce4ec;
  --text-main: #37352f;
  --text-light: #787774;
  --bg-color: #f7f6f3; 
  --card-bg: #ffffff;
  --input-bg: #f3f4f6; 
  --border-color: #ebebeb;
}

* { box-sizing: border-box; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg-color);
  color: var(--text-main);
  margin: 0;
  height: 100vh; 
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden; 
}

.app {
  width: 100%;
  max-width: 1100px;
  padding: 0 20px;
  position: relative;
}

.container {
  display: grid;
  grid-template-columns: 1fr 320px;
  gap: 20px;
}

.main-card, .sidebar-card {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.03);
  border: 1px solid rgba(0,0,0,0.04);
  height: 640px; 
  display: flex;
  flex-direction: column;
  position: relative;
  overflow: hidden; 
}

@media (max-width: 850px) {
    body {
        height: auto; 
        overflow-y: auto; 
        align-items: flex-start; 
        padding-top: 20px;
        padding-bottom: 40px;
    }
    .container {
        grid-template-columns: 1fr; 
        display: flex;
        flex-direction: column;
    }
    .main-card, .sidebar-card {
        height: auto; 
        min-height: 500px;
    }
    .charts-area {
        flex-direction: column; 
        height: auto !important;
    }
    .chart-wrapper-pie, .chart-wrapper-line {
        width: 100% !important;
        height: 250px !important;
        margin-bottom: 20px;
    }
    input, select { font-size: 16px !important; }
}

.card-header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  flex-shrink: 0;
  flex-wrap: wrap; 
  gap: 10px;
}

.header-controls {
    display: flex;
    gap: 8px;
    align-items: center;
}

#syncStatus {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-light);
    display: flex;
    align-items: center;
    gap: 6px;
    margin-right: 6px;
    cursor: pointer;
}
.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #ccc;
}
.status-green { background: var(--matcha-dark); box-shadow: 0 0 5px var(--matcha); }
.status-yellow { background: #fbc02d; }
.status-red { background: var(--strawberry-dark); }

.settings-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 16px;
    padding: 4px;
    color: var(--text-light);
    opacity: 0.6;
    transition: 0.2s;
}
.settings-btn:hover { opacity: 1; transform: rotate(45deg); }

.tabs {
  display: flex;
  gap: 4px;
  background: #f4f4f5;
  padding: 4px;
  border-radius: 10px;
}
.tabs button {
  padding: 6px 14px;
  border-radius: 8px;
  border: none;
  background: transparent;
  color: var(--text-light);
  font-weight: 500;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s ease;
}
.tabs button.active {
  background: white;
  color: var(--strawberry-dark);
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  font-weight: 600;
}

.header-select {
    width: auto;
    min-width: 80px; 
    border: none;
    background: #f4f4f5;
    padding: 6px 12px;
    border-radius: 8px;
    font-weight: 600;
    color: var(--text-main);
    cursor: pointer;
    font-size: 13px;
}
.header-select:hover { background: #eaeaeb; }

.tab-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    padding: 2px;
}
@media (max-width: 850px) {
    .tab-content { overflow: visible; }
}
.hidden { display: none !important; }

label {
  display: block;
  font-size: 11px;
  font-weight: 700;
  color: var(--text-light);
  margin-bottom: 5px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
input, select {
  width: 100%;
  padding: 9px 12px;
  border-radius: 8px;
  border: 1px solid transparent; 
  font-size: 13px;
  background: var(--input-bg);
  transition: all 0.2s;
  color: var(--text-main);
}
input:focus, select:focus {
  outline: none;
  background: #fff;
  border-color: var(--strawberry);
  box-shadow: 0 0 0 3px var(--strawberry-light);
}

.add-expense-box {
    background: #FAFAFA;
    padding: 18px;
    border-radius: 12px;
    margin-top: 16px;
    border: 1px solid #eeeeee;
}
.box-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}
.box-header-row h3 {
    margin: 0;
    color: var(--text-main);
    font-size: 14px;
}

.add-expense-box input, 
.add-expense-box select {
    background: #FFFFFF;
    border: 1px solid #e0e0e0; 
}
.add-expense-box input:focus, 
.add-expense-box select:focus {
    border-color: var(--strawberry);
}

.btn-primary {
  background: var(--strawberry);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 10px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  margin-top: 14px;
  font-size: 14px;
  transition: transform 0.1s, background 0.2s;
  box-shadow: 0 4px 10px rgba(244, 143, 177, 0.3);
}
.btn-primary:hover { background: var(--strawberry-hover); transform: translateY(-1px); }

.btn-secondary {
    background: transparent;
    border: 1px solid #ccc;
    color: var(--text-light);
    border-radius: 8px;
    padding: 8px;
    font-weight: 600;
    cursor: pointer;
    font-size: 13px;
    margin-top: 8px;
    transition: 0.2s;
}
.btn-secondary:hover { background: #eee; color: var(--text-main); }

.btn-delete {
    background: transparent;
    color: #ff6b6b;
    border: none;
    font-size: 14px;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
}
.btn-delete:hover { background: #ffebee; }

/* TABLE & SEARCH */
.table-controls {
    display: flex;
    margin-bottom: 10px;
    gap: 10px;
}
#searchInput {
    background: #fff;
    border: 1px solid #e0e0e0;
    padding: 8px 12px;
    font-size: 13px;
    border-radius: 8px;
}

.table-container {
    height: 100%; 
    min-height: 300px;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden; 
    display: flex;
    flex-direction: column;
}
.expenses-scroll { overflow-y: auto; flex: 1; }
.expenses-scroll::-webkit-scrollbar { width: 6px; }
.expenses-scroll::-webkit-scrollbar-track { background: transparent; }
.expenses-scroll::-webkit-scrollbar-thumb { background: #e0e0e0; border-radius: 4px; }
table { width: 100%; border-collapse: collapse; }
th {
  background: #fff; text-align: left; padding: 12px; font-size: 11px;
  color: var(--text-light); font-weight: 600; position: sticky; top: 0;
  border-bottom: 1px solid var(--border-color); z-index: 10;
  cursor: pointer;
  user-select: none;
}
th:hover { background: #f9f9f9; color: var(--strawberry-dark); }
td { padding: 8px 12px; border-bottom: 1px solid var(--border-color); font-size: 13px; vertical-align: middle; }
td input, td select {
    padding: 5px; font-size: 13px; margin: -5px; width: calc(100% + 10px);
    background: transparent; border: 1px solid transparent;
}
td input:hover, td select:hover { background: #f5f5f5; }
td input:focus, td select:focus { background: white; border-color: var(--strawberry); box-shadow: none; }

.dashboard-grid {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; flex-shrink: 0;
}
.kpi-card { border-radius: 12px; padding: 14px; text-align: center; color: white; }
.kpi-card h4 { margin: 0 0 4px 0; font-weight: 500; font-size: 12px; opacity: 0.95; }
.kpi-card strong { font-size: 18px; font-weight: 700; }
.bg-pink { background: var(--strawberry); }
.bg-green { background: var(--matcha); }

.charts-area {
    background: #fafafa; border-radius: 16px; padding: 16px;
    border: 1px solid rgba(0,0,0,0.03); flex: 1; display: flex; gap: 16px;
    align-items: center; overflow: hidden; min-height: 0; 
}
.chart-wrapper-pie { width: 35%; height: 100%; position: relative; }
.chart-wrapper-line { width: 65%; height: 100%; position: relative; }

/* Average Spending Box */
.average-stats-box {
    margin-top: 15px;
    background: #f9f9f9;
    border: 1px solid #eee;
    padding: 12px;
    border-radius: 10px;
    text-align: center;
    font-size: 13px;
    color: var(--text-main);
}
.avg-highlight { font-weight: 700; color: var(--strawberry-dark); }
.avg-good { color: var(--matcha-dark); font-weight: 700; }
.avg-culprit { display: block; margin-top: 4px; font-size: 11px; color: var(--text-light); }

.sidebar-section { margin-bottom: 24px; }
.summary-item {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 8px; padding: 8px 12px; border-radius: 10px; font-size: 13px;
}

/* === MODIFIERAD HEALTH-STYLE (MATCHING EXPENSES) === */
.summary-item.health-item {
    background: var(--strawberry-light);
    color: var(--strawberry-dark);
    margin-top: 8px;
}
.summary-item.health-item span:first-child {
    font-weight: 700;
}
.summary-item.health-item span:last-child {
    font-weight: 500;
}

.sum-green { background: var(--matcha-light); color: var(--matcha-dark); }
.sum-pink { background: var(--strawberry-light); color: var(--strawberry-dark); }
.summary-item span:first-child { font-weight: 500; }
.summary-item span:last-child { font-weight: 700; font-size: 14px; }

.progress-group { margin-bottom: 16px; }
.progress-header {
    display: flex; justify-content: space-between; font-size: 11px;
    margin-bottom: 6px; color: var(--text-light); font-weight: 600;
}
.progress-track { height: 8px; background: #f0f0f0; border-radius: 20px; overflow: hidden; }
.progress-fill { height: 100%; transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1); }

.remaining-card {
    background: var(--strawberry); color: white; padding: 18px;
    border-radius: 14px; text-align: center; margin-top: auto; 
    box-shadow: 0 4px 12px rgba(244, 143, 177, 0.4);
}
.remaining-card p { margin: 0 0 6px 0; font-size: 12px; opacity: 0.9; }
.remaining-card strong { font-size: 26px; display: block; }

.btn-export {
    margin-top: 10px; width: 100%; background: transparent; border: 1px dashed #ccc;
    color: var(--text-light); padding: 8px; border-radius: 8px; cursor: pointer;
    font-size: 11px; transition: all 0.2s;
}
.btn-export:hover { border-color: var(--strawberry); color: var(--strawberry); background: var(--strawberry-light); }

.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.grid-4 { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; }

@media (max-width: 600px) {
    .grid-4 { grid-template-columns: 1fr 1fr; } 
}

.overlay-screen {
    position: absolute; top:0; left:0; width:100%; height:100%;
    background: rgba(255,255,255,0.98);
    z-index: 200;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    text-align: center; padding: 40px;
    border-radius: 16px;
}
.overlay-screen h2 { color: var(--matcha-dark); margin-bottom: 10px; }
.overlay-screen p { color: var(--text-light); font-size: 14px; max-width: 400px; line-height: 1.5; margin-bottom: 20px; }
.setup-input { 
    padding: 12px; width: 300px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; margin-bottom: 10px;
}
.setup-input:focus { border-color: var(--strawberry); outline: none; }

.reset-link {
    margin-top: 15px; font-size: 12px; color: var(--strawberry-dark); 
    text-decoration: underline; cursor: pointer;
}
.remember-me {
    margin-top: 12px;
    font-size: 13px;
    color: var(--text-light);
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}
.remember-me input { width: auto; margin: 0; cursor: pointer; }

.btn-import {
    background: transparent; border: 1px solid var(--matcha); color: var(--matcha-dark);
    font-size: 11px; padding: 4px 8px; border-radius: 6px; cursor: pointer; font-weight: 600;
}
.btn-import:hover { background: var(--matcha-light); }

/* --- TOAST NOTIFICATIONS --- */
#toastContainer {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
    pointer-events: none;
}
.toast {
    background: #333;
    color: white;
    padding: 10px 20px;
    border-radius: 30px;
    font-size: 13px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: flex;
    align-items: center;
    gap: 8px;
}
.toast.show { opacity: 1; transform: translateY(0); }
.toast-success { background: var(--matcha-dark); }
.toast-error { background: var(--strawberry-dark); }

</style>
</head>

<body>
<div class="app">

  <div id="setupScreen" class="overlay-screen hidden">
      <h2>Welcome to Budget Buddy! üçì</h2>
      <p>Enter your Pantry ID to sync expenses.</p>
      
      <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:20px; text-align:left; font-size:13px;">
          1. Go to <a href="https://getpantry.cloud/" target="_blank" style="color:var(--strawberry-dark)">getpantry.cloud</a><br>
          2. Click "Create Pantry" & enter any email.<br>
          3. Copy your <strong>Pantry ID</strong>.<br>
          4. Paste it below.
      </div>

      <input type="text" id="pantryIdInput" class="setup-input" placeholder="Paste ID here..." />
      <button class="btn-primary" style="width:300px" onclick="savePantryId()">Start Tracking</button>
      
      <label class="remember-me">
          <input type="checkbox" id="rememberMeCheck" checked> 
          Keep me signed in on this device
      </label>

      <button id="cancelSetupBtn" class="btn-secondary hidden" style="width:300px" onclick="closeSetup()">Cancel</button>
  </div>
  
  <div id="toastContainer"></div>

  <div class="container">
    
    <div class="main-card">
        <div class="card-header-row">
            <div class="tabs">
                <button class="active" onclick="showTab('track')">Track</button>
                <button onclick="showTab('expenses')">Expenses</button>
                <button onclick="showTab('charts')">Charts</button>
            </div>
            
            <div class="header-controls">
                <div id="syncStatus" title="Status" onclick="attemptSync()">
                    <div class="status-dot status-yellow" id="statusDot"></div>
                    <span id="statusText" style="font-size:10px;">Checking...</span>
                </div>
                <button class="settings-btn" onclick="openSetup()" title="Settings">‚öôÔ∏è</button>
                <select id="currencySelect" class="header-select" onchange="changeCurrency()">
                    <option value="kr">SEK (kr)</option>
                    <option value="‚Ç¨">EUR (‚Ç¨)</option>
                    <option value="$">USD ($)</option>
                    <option value="¬£">GBP (¬£)</option>
                    <option value="‚Çπ">INR (‚Çπ)</option>
                </select>
                <select id="monthSelect" class="header-select" onchange="changeMonth()"></select>
            </div>
        </div>

        <div id="track" class="tab-content">
            <div class="grid-2">
                <div>
                    <label>Monthly Income</label>
                    <input id="income" type="number" onchange="debouncedSave()" placeholder="e.g. 25000" />
                </div>
                <div>
                    <label>Monthly Budget (Limit)</label>
                    <input id="monthlyBudget" type="number" onchange="debouncedSave()" placeholder="Max spending" />
                </div>
            </div>
            <div class="grid-2" style="margin-top:16px;">
                 <div>
                    <label>Monthly Savings Goal</label>
                    <input id="monthlySavingsGoal" type="number" onchange="debouncedSave()" placeholder="e.g. 2000" />
                </div>
                <div>
                    <label>Longterm Savings Goal</label>
                    <input id="longtermSavingsGoal" type="number" onchange="debouncedSave()" placeholder="Total Target" />
                </div>
            </div>

            <div class="add-expense-box">
                <div class="box-header-row">
                    <h3>Add New Expense</h3>
                    <button class="btn-import" onclick="importRecurring()">üîÑ Import Fixed</button>
                </div>

                <div class="grid-4">
                    <div>
                        <label>Name</label>
                        <input id="inputName" placeholder="Item name" />
                    </div>
                    <div>
                        <label>Amount</label>
                        <input id="inputAmount" type="number" placeholder="0" />
                    </div>
                    <div>
                        <label>Type</label>
                        <select id="inputType">
                            <option>Fixed</option>
                            <option>Variable</option>
                        </select>
                    </div>
                    <div>
                        <label>Category</label>
                        <select id="inputCategory">
                            <option value="Rent">üè† Rent</option>
                            <option value="Food">üçî Food</option>
                            <option value="Fun">üéâ Fun</option>
                            <option value="Travel">‚úàÔ∏è Travel</option>
                            <option value="Subscriptions">üì∫ Subs</option>
                            <option value="Bills">‚ö° Bills</option>
                            <option value="Saved">üí∞ Saved</option>
                            <option value="Other">üì¶ Other</option>
                        </select>
                    </div>
                </div>
                
                <button id="addBtn" class="btn-primary" onclick="addExpense()">+ Add Expense</button>
            </div>
        </div>

        <div id="expenses" class="tab-content hidden">
            <div class="table-controls">
                <input id="searchInput" placeholder="Search expenses..." onkeyup="filterExpenses()" style="width:100%">
            </div>

            <div class="table-container">
                <div class="expenses-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th style="width:120px;" onclick="sortExpenses('date')">Date ‚Üï</th>
                                <th onclick="sortExpenses('name')">Name ‚Üï</th>
                                <th style="width:90px;" onclick="sortExpenses('amount')">Amount ‚Üï</th>
                                <th style="width:80px;">Type</th>
                                <th style="width:120px;">Category</th>
                                <th style="width:30px;"></th>
                            </tr>
                        </thead>
                        <tbody id="expenseTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="charts" class="tab-content hidden">
            <div class="dashboard-grid">
                <div class="kpi-card bg-pink">
                    <h4>Income</h4>
                    <strong id="kIncome">0</strong>
                </div>
                <div class="kpi-card bg-green">
                    <h4>Expenses</h4>
                    <strong id="kExpenses">0</strong>
                </div>
                <div class="kpi-card bg-pink">
                    <h4>Saved</h4>
                    <strong id="kSaved">0</strong>
                </div>
            </div>

            <div class="charts-area">
                <div class="chart-wrapper-pie">
                    <canvas id="pieChart"></canvas>
                </div>
                <div class="chart-wrapper-line">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>

            <div id="averageStats" class="average-stats-box hidden"></div>
        </div>

    </div>

    <div class="sidebar-card">
        <h3 style="margin-top:0; margin-bottom:16px; font-size:16px;">Monthly Summary</h3>
        
        <div class="sidebar-section">
            <div class="summary-item sum-green">
                <span>Income</span>
                <span id="sIncome">0</span>
            </div>
            <div class="summary-item sum-pink">
                <span>Expenses</span>
                <span id="sExpenses">0</span>
            </div>
            <div class="summary-item sum-green">
                <span>Saved</span>
                <span id="sSaved">0</span>
            </div>
            <div class="summary-item health-item">
                <span>Health</span>
                <span id="healthScore">...</span>
            </div>
        </div>

        <div class="progress-group">
            <div class="progress-header">
                <span>Income Usage</span>
                <span id="incomeUsageText">0%</span>
            </div>
            <div class="progress-track">
                <div id="incomeBar" class="progress-fill" style="background:var(--matcha); width:0%"></div>
            </div>
        </div>

        <div class="progress-group">
            <div class="progress-header">
                <span>Longterm Goal Progress</span>
                <span id="goalText">0%</span>
            </div>
            <div class="progress-track">
                <div id="saveBar" class="progress-fill" style="background:var(--strawberry); width:0%"></div>
            </div>
        </div>

        <div class="remaining-card">
            <p>Remaining this month</p>
            <strong id="remaining">0</strong>
        </div>

        <button class="btn-export" onclick="exportCSV()">Export CSV</button>
    </div>

  </div>
</div>

<script>
// ==========================================
// CONFIG: HARDCODE ID FOR AUTO-LOGIN
// ==========================================
const HARDCODED_PANTRY_ID = ""; 
// ==========================================

const BASKET_NAME = "expenseTracker"; 
let userPantryId = null; 

let fullData = {}; 
let settings = { currency: "kr" };
let currentMonth = new Date().toISOString().slice(0,7);
let saveTimeout;

const catIcons = {
    "Rent": "üè†", "Food": "üçî", "Fun": "üéâ", "Travel": "‚úàÔ∏è",
    "Subscriptions": "üì∫", "Bills": "‚ö°", "Saved": "üí∞", "Other": "üì¶"
};

// -- INIT: OFFLINE FIRST --
initMonths();
initApp();

function initApp() {
    // 1. Try to get ID from Code, Local, Session
    if(HARDCODED_PANTRY_ID && HARDCODED_PANTRY_ID.length > 5) {
        userPantryId = HARDCODED_PANTRY_ID;
    } else {
        userPantryId = localStorage.getItem("userPantryId") || sessionStorage.getItem("userPantryId");
    }

    if(!userPantryId) {
        document.getElementById('setupScreen').classList.remove('hidden');
    } else {
        // User exists -> Load LOCAL data first (Instant)
        const cached = localStorage.getItem("budgetData_cache");
        if(cached) {
            try {
                const parsed = JSON.parse(cached);
                fullData = parsed.data || {};
                settings = parsed.settings || { currency: "kr" };
                console.log("Loaded from cache");
                render(); 
            } catch(e) { console.error("Cache corrupt"); }
        }
        
        // Then try to Sync with Cloud in background
        attemptSync();
    }
}

function savePantryId() {
    const input = document.getElementById('pantryIdInput').value.trim();
    const remember = document.getElementById('rememberMeCheck').checked;

    if(input.length < 5) {
        showToast("Please enter a valid Pantry ID", "error");
        return;
    }
    userPantryId = input;
    if(remember) localStorage.setItem("userPantryId", userPantryId);
    else sessionStorage.setItem("userPantryId", userPantryId);

    document.getElementById('setupScreen').classList.add('hidden');
    attemptSync();
}

function openSetup() {
    document.getElementById('pantryIdInput').value = userPantryId || "";
    document.getElementById('setupScreen').classList.remove('hidden');
    document.getElementById('cancelSetupBtn').classList.remove('hidden');
}

function closeSetup() {
    document.getElementById('setupScreen').classList.add('hidden');
}

function setStatus(state) {
    const dot = document.getElementById('statusDot');
    const txt = document.getElementById('statusText');
    if(state === 'loading') { 
        dot.className = "status-dot status-yellow"; 
        txt.textContent = "Syncing...";
    }
    else if (state === 'saved') { 
        dot.className = "status-dot status-green"; 
        txt.textContent = "Synced";
    }
    else { 
        dot.className = "status-dot status-red"; 
        txt.textContent = "Offline";
    }
}

function showToast(message, type = "success") {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type === 'error' ? 'toast-error' : 'toast-success'}`;
    toast.innerHTML = type === 'error' ? `‚ö†Ô∏è ${message}` : `‚úÖ ${message}`;
    container.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// === CORE SYNC LOGIC (PANTRY) ===
async function attemptSync() {
    if(!userPantryId) return;
    setStatus('loading');
    
    try {
        const url = `https://getpantry.cloud/apiv1/pantry/${userPantryId}/basket/${BASKET_NAME}`;
        
        // Short timeout for sync check
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), 6000); 
        
        const res = await fetch(url, { signal: controller.signal });
        clearTimeout(id);
        
        if(!res.ok) {
            if(res.status === 404) {
                 await createInitialBasket(); 
                 return;
            }
            throw new Error("Server error");
        }

        const json = await res.json();
        
        // Merge Cloud Data if valid
        if(json.data) {
            fullData = json.data;
            settings = json.settings || { currency: "kr" };
            
            // Update Local Cache
            localStorage.setItem("budgetData_cache", JSON.stringify({ data: fullData, settings: settings }));
            
            document.getElementById('currencySelect').value = settings.currency;
            render();
            setStatus('saved');
        }

    } catch(e) {
        console.warn("Sync failed, running offline", e);
        setStatus('error'); 
    }
}

async function createInitialBasket() {
    try {
        const payload = { data: fullData, settings: settings };
        const url = `https://getpantry.cloud/apiv1/pantry/${userPantryId}/basket/${BASKET_NAME}`;
        await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        setStatus('saved');
    } catch(e) {}
}

async function saveData() {
    // 1. Save to Local Storage immediately
    localStorage.setItem("budgetData_cache", JSON.stringify({ data: fullData, settings: settings }));
    setStatus('loading');

    // 2. Try push to Cloud
    if(!userPantryId) return;
    try {
        const payload = { data: fullData, settings: settings };
        const url = `https://getpantry.cloud/apiv1/pantry/${userPantryId}/basket/${BASKET_NAME}`;
        
        // Don't wait forever on save either
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), 8000);

        const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
            signal: controller.signal
        });
        clearTimeout(id);
        
        if(res.ok) setStatus('saved');
        else throw new Error("Cloud save failed");
    } catch(e) {
        setStatus('error'); // Keeps working locally
    }
}

function debouncedSave() {
    saveMetaLocally(); 
    clearTimeout(saveTimeout);
    setStatus('loading'); 
    saveTimeout = setTimeout(saveData, 1500);
}

// -- APP LOGIC (UNCHANGED) --
function formatMoney(num) {
    if(!num && num !== 0) return "0 " + settings.currency;
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " " + settings.currency;
}

function initMonths(){
  const sel = document.getElementById('monthSelect');
  if(!sel) return;
  sel.innerHTML = "";
  for(let i=0; i<6; i++){
    const d = new Date();
    d.setMonth(d.getMonth() - i);
    const m = d.toISOString().slice(0,7);
    const opt = document.createElement('option');
    opt.value = m;
    opt.innerText = m;
    sel.appendChild(opt);
  }
  sel.value = currentMonth;
}

function getMonth(){
  if(!fullData[currentMonth]) fullData[currentMonth] = { income: 0, monthlyBudget: 0, monthlySavingsGoal: 0, longtermSavingsGoal: 0, expenses: [] };
  return fullData[currentMonth];
}

function changeMonth(){ 
    currentMonth = document.getElementById('monthSelect').value; 
    render(); 
}

function changeCurrency() {
    settings.currency = document.getElementById('currencySelect').value;
    saveData();
    render();
    showToast("Currency Updated");
}

function saveMetaLocally(){
  const m = getMonth();
  m.income = +document.getElementById('income').value;
  m.monthlyBudget = +document.getElementById('monthlyBudget').value;
  m.monthlySavingsGoal = +document.getElementById('monthlySavingsGoal').value;
  m.longtermSavingsGoal = +document.getElementById('longtermSavingsGoal').value;
  render(); 
}

function addExpense(){
  const nameVal = document.getElementById('inputName').value;
  const amountVal = document.getElementById('inputAmount').value;
  const typeVal = document.getElementById('inputType').value;
  const catVal = document.getElementById('inputCategory').value;

  if(!nameVal || !amountVal) {
      showToast("Enter name and amount", "error");
      return;
  }

  getMonth().expenses.push({
    id: Date.now(),
    name: nameVal,
    amount: +amountVal,
    type: typeVal,
    category: catVal,
    date: new Date().toISOString().slice(0,10)
  });

  document.getElementById('inputName').value = "";
  document.getElementById('inputAmount').value = "";
  
  saveData(); 
  render();
  showToast("Expense Added");
}

function importRecurring() {
    let d = new Date(currentMonth + "-01");
    d.setMonth(d.getMonth() - 1);
    const prevMonthStr = d.toISOString().slice(0,7);
    
    if(!fullData[prevMonthStr] || !fullData[prevMonthStr].expenses) {
        showToast("No data for " + prevMonthStr, "error");
        return;
    }

    const fixedExpenses = fullData[prevMonthStr].expenses.filter(e => e.type === "Fixed");
    
    if(fixedExpenses.length === 0) {
        showToast("No fixed expenses in " + prevMonthStr, "error");
        return;
    }

    if(confirm(`Found ${fixedExpenses.length} fixed expenses. Import?`)) {
        const m = getMonth();
        let count = 0;
        fixedExpenses.forEach((e, index) => {
            m.expenses.push({
                id: Date.now() + index, name: e.name, amount: e.amount, type: e.type, category: e.category, date: currentMonth + "-01" 
            });
            count++;
        });
        saveData();
        render();
        showToast(`Imported ${count} expenses`);
    }
}

window.updateExpense = function(index, field, element) {
    const m = getMonth();
    let val = element.value;
    if(field === 'amount') val = Number(val);
    const displayedItem = currentDisplayedExpenses[index];
    if(!displayedItem) return;
    const realIndex = m.expenses.findIndex(e => e.id === displayedItem.id);
    if(realIndex !== -1) {
        m.expenses[realIndex][field] = val;
        clearTimeout(saveTimeout);
        setStatus('loading');
        saveTimeout = setTimeout(saveData, 2000); 
    }
}

function deleteExpense(id){
    const m = getMonth();
    const realIndex = m.expenses.findIndex(e => e.id === id);
    if(realIndex !== -1 && confirm("Delete this expense?")){
        m.expenses.splice(realIndex, 1);
        saveData();
        render(); 
        showToast("Expense Deleted");
    }
}

let sortCol = null;
let sortAsc = true;
let currentDisplayedExpenses = [];

function sortExpenses(col) {
    if(sortCol === col) sortAsc = !sortAsc;
    else { sortCol = col; sortAsc = true; }
    render();
}

function filterExpenses() { render(); }

let pieChartInstance, lineChartInstance;

function render(){
  const m = getMonth();
  
  if(document.activeElement.id !== 'income') document.getElementById('income').value = m.income || "";
  if(document.activeElement.id !== 'monthlyBudget') document.getElementById('monthlyBudget').value = m.monthlyBudget || "";
  if(document.activeElement.id !== 'monthlySavingsGoal') document.getElementById('monthlySavingsGoal').value = m.monthlySavingsGoal || "";
  if(document.activeElement.id !== 'longtermSavingsGoal') document.getElementById('longtermSavingsGoal').value = m.longtermSavingsGoal || "";

  let totalExp = m.expenses.filter(e => e.category !== "Saved").reduce((a,b) => a + b.amount, 0);
  let totalSaved = m.expenses.filter(e => e.category === "Saved").reduce((a,b) => a + b.amount, 0);
  let remainingVal = m.income - totalExp - totalSaved;

  document.getElementById('kIncome').textContent = formatMoney(m.income);
  document.getElementById('sIncome').textContent = formatMoney(m.income);
  document.getElementById('kExpenses').textContent = formatMoney(totalExp);
  document.getElementById('sExpenses').textContent = formatMoney(totalExp);
  document.getElementById('kSaved').textContent = formatMoney(totalSaved);
  document.getElementById('sSaved').textContent = formatMoney(totalSaved);
  document.getElementById('remaining').textContent = formatMoney(remainingVal.toFixed(2));

  // --- HEALTH SCORE ---
  const healthEl = document.getElementById('healthScore');
  const budgetRatio = m.monthlyBudget > 0 ? (totalExp / m.monthlyBudget) : 0;
  if(!m.income) healthEl.innerText = "Add Income üü°";
  else if(remainingVal < 0) healthEl.innerText = "Over Budget üî¥";
  else if(budgetRatio > 0.9) healthEl.innerText = "Near Limit üü°";
  else healthEl.innerText = "On Track üü¢";

  const incomePct = m.income ? Math.min((totalExp / m.income) * 100, 100) : 0;
  document.getElementById('incomeBar').style.width = incomePct + "%";
  document.getElementById('incomeUsageText').textContent = incomePct.toFixed(0) + "% used";
  const goalPct = m.longtermSavingsGoal ? Math.min((totalSaved / m.longtermSavingsGoal) * 100, 100) : 0;
  document.getElementById('saveBar').style.width = goalPct + "%";
  document.getElementById('goalText').textContent = goalPct.toFixed(0) + "% reached";

  const searchVal = document.getElementById('searchInput').value.toLowerCase();
  let list = m.expenses.filter(e => e.name.toLowerCase().includes(searchVal) || e.category.toLowerCase().includes(searchVal));
  if(sortCol) {
      list.sort((a,b) => {
          let va = a[sortCol]; let vb = b[sortCol];
          if(typeof va === 'string') va = va.toLowerCase(); if(typeof vb === 'string') vb = vb.toLowerCase();
          if(va < vb) return sortAsc ? -1 : 1; if(va > vb) return sortAsc ? 1 : -1; return 0;
      });
  }
  currentDisplayedExpenses = list;
  document.getElementById('expenseTable').innerHTML = list.map((e, i) => `
    <tr>
      <td><input type="date" value="${e.date}" onchange="updateExpense(${i}, 'date', this)"></td>
      <td><input type="text" value="${e.name}" onchange="updateExpense(${i}, 'name', this)"></td>
      <td><input type="number" value="${e.amount}" onchange="updateExpense(${i}, 'amount', this)"></td>
      <td><select onchange="updateExpense(${i}, 'type', this)"><option ${e.type=="Fixed"?"selected":""}>Fixed</option><option ${e.type=="Variable"?"selected":""}>Variable</option></select></td>
      <td><select onchange="updateExpense(${i}, 'category', this)"><option value="Rent" ${e.category=="Rent"?"selected":""}>üè† Rent</option><option value="Food" ${e.category=="Food"?"selected":""}>üçî Food</option><option value="Fun" ${e.category=="Fun"?"selected":""}>üéâ Fun</option><option value="Travel" ${e.category=="Travel"?"selected":""}>‚úàÔ∏è Travel</option><option value="Subscriptions" ${e.category=="Subscriptions"?"selected":""}>üì∫ Subs</option><option value="Bills" ${e.category=="Bills"?"selected":""}>‚ö° Bills</option><option value="Saved" ${e.category=="Saved"?"selected":""}>üí∞ Saved</option><option value="Other" ${e.category=="Other"?"selected":""}>üì¶ Other</option></select></td>
      <td><button class="btn-delete" onclick="deleteExpense(${e.id})">‚úï</button></td>
    </tr>`).join("");

  renderAverageStats(m, totalExp);
  drawCharts(m);
}

function renderAverageStats(currentMonthData, currentSpending) {
    const box = document.getElementById('averageStats');
    const months = Object.keys(fullData).filter(m => m !== currentMonth && m < currentMonth);
    if(months.length === 0) { box.classList.add('hidden'); return; }
    let totalSum = 0; let catSums = {}; let monthCount = months.length;
    months.forEach(mKey => {
        const monthData = fullData[mKey];
        if(monthData && monthData.expenses) {
             const mExp = monthData.expenses.filter(e => e.category !== "Saved");
             totalSum += mExp.reduce((a,b) => a + b.amount, 0);
             mExp.forEach(e => { catSums[e.category] = (catSums[e.category] || 0) + e.amount; });
        }
    });
    const avgTotal = totalSum / monthCount; const totalDiff = currentSpending - avgTotal;
    box.classList.remove('hidden');
    let msg = `Average: <strong>${formatMoney(avgTotal.toFixed(0))}</strong>. `;
    if(totalDiff > 0) {
        msg += `<span class="avg-highlight">‚ñ≤ +${formatMoney(totalDiff.toFixed(0))} vs avg.</span>`;
        let maxDiff = 0; let culprit = ""; let currentCatTotals = {};
        currentMonthData.expenses.filter(e => e.category !== "Saved").forEach(e => { currentCatTotals[e.category] = (currentCatTotals[e.category] || 0) + e.amount; });
        for (let cat in currentCatTotals) {
             let catAvg = (catSums[cat] || 0) / monthCount; let diff = currentCatTotals[cat] - catAvg;
             if(diff > maxDiff) { maxDiff = diff; culprit = cat; }
        }
        if(culprit && maxDiff > 100) { msg += `<span class="avg-culprit">Mainly due to: ${catIcons[culprit]||""} ${culprit} (+${formatMoney(maxDiff.toFixed(0))})</span>`; }
    } else { msg += `<span class="avg-good">‚ñº -${formatMoney(Math.abs(totalDiff).toFixed(0))} vs avg.</span>`; }
    box.innerHTML = msg;
}

function drawCharts(m){
  const cats = {};
  m.expenses.filter(e => e.category !== "Saved").forEach(e => { cats[e.category] = (cats[e.category] || 0) + e.amount; });
  const pieCtx = document.getElementById('pieChart').getContext('2d');
  if(pieChartInstance) pieChartInstance.destroy();
  const colors = ["#f48fb1", "#8fc7a4", "#a5d6a7", "#f06292", "#c8e6c9", "#f8bbd0", "#ffecb3", "#b39ddb"];
  const labelsWithIcons = Object.keys(cats).map(k => (catIcons[k] || "") + " " + k);
  pieChartInstance = new Chart(pieCtx, {
      type: "doughnut",
      data: { labels: labelsWithIcons, datasets: [{ data: Object.values(cats), backgroundColor: colors, borderWidth: 0, hoverOffset: 4 }] },
      options: { 
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { position: 'left', labels: { boxWidth: 10, font: {size: 10} } } },
          onClick: (evt, elements) => {
              if(elements.length > 0) {
                  const idx = elements[0].index; const categoryName = Object.keys(cats)[idx]; 
                  showTab('expenses'); document.getElementById('searchInput').value = categoryName; filterExpenses(); showToast(`Showing ${categoryName} expenses`);
              }
          }
      }
  });
  const lineCtx = document.getElementById('lineChart').getContext('2d');
  if(lineChartInstance) lineChartInstance.destroy();
  const year = parseInt(currentMonth.split('-')[0]); const month = parseInt(currentMonth.split('-')[1]); const daysInMonth = new Date(year, month, 0).getDate();
  const labels = Array.from({length: daysInMonth}, (_, i) => "Day " + (i + 1));
  const dailyExpenses = new Array(daysInMonth).fill(0); const dailySavings = new Array(daysInMonth).fill(0);
  const sortedExp = [...m.expenses].sort((a,b) => new Date(a.date) - new Date(b.date));
  let cumExp = 0; let cumSave = 0;
  for (let day = 1; day <= daysInMonth; day++) {
      const dayStr = `${currentMonth}-${String(day).padStart(2, '0')}`;
      sortedExp.filter(e => e.date === dayStr).forEach(e => { if(e.category === "Saved") cumSave += e.amount; else cumExp += e.amount; });
      dailyExpenses[day - 1] = cumExp; dailySavings[day - 1] = cumSave;
  }
  lineChartInstance = new Chart(lineCtx, {
      type: "line",
      data: {
          labels: labels,
          datasets: [
            { label: "Spending", data: dailyExpenses, borderColor: "#f48fb1", backgroundColor: "rgba(244, 143, 177, 0.1)", borderWidth: 2, pointRadius: 1, tension: 0.1, fill: true },
            { label: "Budget Limit", data: labels.map(() => m.monthlyBudget), borderColor: "#f48fb1", borderDash: [5, 5], borderWidth: 1.5, pointRadius: 0, fill: false },
            { label: "Savings", data: dailySavings, borderColor: "#669e7c", backgroundColor: "rgba(102, 158, 124, 0.1)", borderWidth: 2, pointRadius: 1, tension: 0.1, fill: true },
            { label: "Savings Goal", data: labels.map(() => m.monthlySavingsGoal), borderColor: "#669e7c", borderDash: [5, 5], borderWidth: 1.5, pointRadius: 0, fill: false }
          ]
      },
      options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, scales: { y: { beginAtZero: true, grid: { color: '#f0f0f0' }, ticks: { font: {size: 10} } }, x: { grid: { display: false }, ticks: { maxTicksLimit: 10 } } }, plugins: { legend: { display: false } } }
  });
}

function showTab(id){
  document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
  const btn = Array.from(document.querySelectorAll(".tabs button")).find(b => b.textContent.toLowerCase() === id);
  if(btn) btn.classList.add("active");
  document.querySelectorAll('.tab-content').forEach(d => d.classList.add('hidden'));
  document.getElementById(id).classList.remove("hidden");
  if(id === 'charts') render();
}

function exportCSV() {
    const m = getMonth();
    let csv = "Date,Name,Amount,Type,Category\n";
    m.expenses.forEach(e => { csv += `${e.date},${e.name},${e.amount},${e.type},${e.category}\n`; });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `budget_${currentMonth}.csv`; a.click();
}
</script>
</body>
</html>
