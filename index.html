<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Expense Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
  /* STRAWBERRY MATCHA PALETTE */
  --matcha: #8fc7a4;
  --matcha-dark: #669e7c; 
  --matcha-light: #e8f5e9;
  
  --strawberry: #f48fb1;
  --strawberry-hover: #ec7aa0;
  --strawberry-dark: #d81b60;
  --strawberry-light: #fce4ec;
  
  --text-main: #37352f;
  --text-light: #787774;
  --bg-color: #f7f6f3; 
  --card-bg: #ffffff;
  --input-bg: #f3f4f6; 
  --border-color: #ebebeb;
}

* { box-sizing: border-box; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg-color);
  color: var(--text-main);
  margin: 0;
  height: 100vh; 
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden; 
}

.app {
  width: 100%;
  max-width: 1100px;
  padding: 0 20px;
  position: relative;
}

/* --- LAYOUT GRID --- */
.container {
  display: grid;
  grid-template-columns: 1fr 320px;
  gap: 20px;
}

/* FIXED HEIGHT CARDS */
.main-card, .sidebar-card {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.03);
  border: 1px solid rgba(0,0,0,0.04);
  height: 510px; 
  display: flex;
  flex-direction: column;
  position: relative;
  overflow: hidden; 
}

/* --- HEADER --- */
.card-header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  flex-shrink: 0;
}

.header-controls {
    display: flex;
    gap: 8px;
    align-items: center;
}

/* Status & Settings */
#syncStatus {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-light);
    display: flex;
    align-items: center;
    gap: 6px;
    margin-right: 6px;
}
.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #ccc;
}
.status-green { background: var(--matcha-dark); }
.status-yellow { background: #fbc02d; }
.status-red { background: var(--strawberry-dark); }

.settings-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 16px;
    padding: 4px;
    color: var(--text-light);
    opacity: 0.6;
    transition: 0.2s;
}
.settings-btn:hover { opacity: 1; transform: rotate(45deg); }


/* TABS */
.tabs {
  display: flex;
  gap: 4px;
  background: #f4f4f5;
  padding: 4px;
  border-radius: 10px;
}

.tabs button {
  padding: 6px 14px;
  border-radius: 8px;
  border: none;
  background: transparent;
  color: var(--text-light);
  font-weight: 500;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.tabs button.active {
  background: white;
  color: var(--strawberry-dark);
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  font-weight: 600;
}

/* DROPDOWNS */
.header-select {
    width: auto;
    border: none;
    background: #f4f4f5;
    padding: 6px 12px;
    border-radius: 8px;
    font-weight: 600;
    color: var(--text-main);
    cursor: pointer;
    font-size: 13px;
}
.header-select:hover { background: #eaeaeb; }
.header-select:focus { outline: none; box-shadow: 0 0 0 2px var(--strawberry-light); }

/* --- CONTENT --- */
.tab-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    padding: 2px;
}
.hidden { display: none !important; }

/* INPUTS */
label {
  display: block;
  font-size: 11px;
  font-weight: 700;
  color: var(--text-light);
  margin-bottom: 5px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
input, select {
  width: 100%;
  padding: 9px 12px;
  border-radius: 8px;
  border: 1px solid transparent; 
  font-size: 13px;
  background: var(--input-bg);
  transition: all 0.2s;
  color: var(--text-main);
}
input:focus, select:focus {
  outline: none;
  background: #fff;
  border-color: var(--strawberry);
  box-shadow: 0 0 0 3px var(--strawberry-light);
}

/* ADD EXPENSE BOX */
.add-expense-box {
    background: #FAFAFA;
    padding: 18px;
    border-radius: 12px;
    margin-top: 16px;
    border: 1px solid #eeeeee;
}
.add-expense-box input, 
.add-expense-box select {
    background: #FFFFFF;
    border: 1px solid #e0e0e0; 
}
.add-expense-box input:focus, 
.add-expense-box select:focus {
    border-color: var(--strawberry);
}

/* BUTTONS */
.btn-primary {
  background: var(--strawberry);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 10px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  margin-top: 14px;
  font-size: 14px;
  transition: transform 0.1s, background 0.2s;
  box-shadow: 0 4px 10px rgba(244, 143, 177, 0.3);
}
.btn-primary:hover { background: var(--strawberry-hover); transform: translateY(-1px); }

.btn-delete {
    background: transparent;
    color: #ff6b6b;
    border: none;
    font-size: 14px;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
}
.btn-delete:hover { background: #ffebee; }

/* TABLE */
.table-container {
    height: 100%; 
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden; 
    display: flex;
    flex-direction: column;
}
.expenses-scroll { overflow-y: auto; flex: 1; }
.expenses-scroll::-webkit-scrollbar { width: 6px; }
.expenses-scroll::-webkit-scrollbar-track { background: transparent; }
.expenses-scroll::-webkit-scrollbar-thumb { background: #e0e0e0; border-radius: 4px; }
table { width: 100%; border-collapse: collapse; }
th {
  background: #fff; text-align: left; padding: 12px; font-size: 11px;
  color: var(--text-light); font-weight: 600; position: sticky; top: 0;
  border-bottom: 1px solid var(--border-color); z-index: 10;
}
td { padding: 8px 12px; border-bottom: 1px solid var(--border-color); font-size: 13px; vertical-align: middle; }
td input, td select {
    padding: 5px; font-size: 13px; margin: -5px; width: calc(100% + 10px);
    background: transparent; border: 1px solid transparent;
}
td input:hover, td select:hover { background: #f5f5f5; }
td input:focus, td select:focus { background: white; border-color: var(--strawberry); box-shadow: none; }

/* CHARTS */
.dashboard-grid {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; flex-shrink: 0;
}
.kpi-card { border-radius: 12px; padding: 14px; text-align: center; color: white; }
.kpi-card h4 { margin: 0 0 4px 0; font-weight: 500; font-size: 12px; opacity: 0.95; }
.kpi-card strong { font-size: 18px; font-weight: 700; }
.bg-pink { background: var(--strawberry); }
.bg-green { background: var(--matcha); }
.charts-area {
    background: #fafafa; border-radius: 16px; padding: 16px;
    border: 1px solid rgba(0,0,0,0.03); flex: 1; display: flex; gap: 16px;
    align-items: center; overflow: hidden; min-height: 0; 
}
.chart-wrapper-pie { width: 35%; height: 100%; position: relative; }
.chart-wrapper-line { width: 65%; height: 100%; position: relative; }

/* SIDEBAR */
.sidebar-section { margin-bottom: 24px; }
.summary-item {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 8px; padding: 8px 12px; border-radius: 10px; font-size: 13px;
}
.sum-green { background: var(--matcha-light); color: var(--matcha-dark); }
.sum-pink { background: var(--strawberry-light); color: var(--strawberry-dark); }
.summary-item span:first-child { font-weight: 500; }
.summary-item span:last-child { font-weight: 700; font-size: 14px; }
.progress-group { margin-bottom: 16px; }
.progress-header {
    display: flex; justify-content: space-between; font-size: 11px;
    margin-bottom: 6px; color: var(--text-light); font-weight: 600;
}
.progress-track { height: 8px; background: #f0f0f0; border-radius: 20px; overflow: hidden; }
.progress-fill { height: 100%; transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
.remaining-card {
    background: var(--strawberry); color: white; padding: 18px;
    border-radius: 14px; text-align: center; margin-top: auto; 
    box-shadow: 0 4px 12px rgba(244, 143, 177, 0.4);
}
.remaining-card p { margin: 0 0 6px 0; font-size: 12px; opacity: 0.9; }
.remaining-card strong { font-size: 26px; display: block; }
.btn-export {
    margin-top: 10px; width: 100%; background: transparent; border: 1px dashed #ccc;
    color: var(--text-light); padding: 8px; border-radius: 8px; cursor: pointer;
    font-size: 11px; transition: all 0.2s;
}
.btn-export:hover { border-color: var(--strawberry); color: var(--strawberry); background: var(--strawberry-light); }
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.grid-4 { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; }

/* --- SCREENS (SETUP / LOADING) --- */
.overlay-screen {
    position: absolute; top:0; left:0; width:100%; height:100%;
    background: rgba(255,255,255,0.98);
    z-index: 200;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    text-align: center; padding: 40px;
    border-radius: 16px;
}
.overlay-screen h2 { color: var(--matcha-dark); margin-bottom: 10px; }
.overlay-screen p { color: var(--text-light); font-size: 14px; max-width: 400px; line-height: 1.5; margin-bottom: 20px; }
.setup-input { 
    padding: 12px; width: 300px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; margin-bottom: 10px;
}
.setup-input:focus { border-color: var(--strawberry); outline: none; }

</style>
</head>

<body>
<div class="app">

  <div id="setupScreen" class="overlay-screen hidden">
      <h2>Welcome to Budget Buddy! üçì</h2>
      <p>To start syncing your expenses across devices (and keep them private), you need a free Pantry ID.</p>
      
      <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:20px; text-align:left; font-size:13px;">
          1. Go to <a href="https://getpantry.cloud/" target="_blank" style="color:var(--strawberry-dark)">getpantry.cloud</a><br>
          2. Click "Create Pantry" & enter your email.<br>
          3. Copy your <strong>Pantry ID</strong>.<br>
          4. Paste it below.
      </div>

      <input type="text" id="pantryIdInput" class="setup-input" placeholder="Paste ID here (e.g. d345...)" />
      <button class="btn-primary" style="width:300px" onclick="savePantryId()">Start Tracking</button>
  </div>

  <div id="loadingOverlay" class="overlay-screen hidden">
      <h3 style="color:var(--matcha-dark)">Syncing...</h3>
  </div>

  <div class="container">
    
    <div class="main-card">
        <div class="card-header-row">
            <div class="tabs">
                <button class="active" onclick="showTab('track')">Track</button>
                <button onclick="showTab('expenses')">Expenses</button>
                <button onclick="showTab('charts')">Charts</button>
            </div>
            
            <div class="header-controls">
                <div id="syncStatus" title="Green = Synced">
                    <div class="status-dot status-yellow" id="statusDot"></div>
                    <span id="statusText">...</span>
                </div>
                
                <button class="settings-btn" onclick="openSetup()" title="Change Cloud ID">‚öôÔ∏è</button>

                <select id="currencySelect" class="header-select" onchange="changeCurrency()">
                    <option value="kr">SEK (kr)</option>
                    <option value="‚Ç¨">EUR (‚Ç¨)</option>
                    <option value="$">USD ($)</option>
                    <option value="¬£">GBP (¬£)</option>
                    <option value="‚Çπ">INR (‚Çπ)</option>
                </select>
                <select id="monthSelect" class="header-select" onchange="changeMonth()"></select>
            </div>
        </div>

        <div id="track" class="tab-content">
            <div class="grid-2">
                <div>
                    <label>Monthly Income</label>
                    <input id="income" type="number" onchange="debouncedSave()" placeholder="e.g. 25000" />
                </div>
                <div>
                    <label>Savings Goal</label>
                    <input id="savingsGoal" type="number" onchange="debouncedSave()" placeholder="e.g. 5000" />
                </div>
            </div>

            <div class="add-expense-box">
                <h3 style="margin-top:0; color: var(--text-main); margin-bottom: 12px; font-size: 14px;">Add New Expense</h3>
                <div class="grid-4">
                    <div>
                        <label>Name</label>
                        <input id="inputName" placeholder="Item name" />
                    </div>
                    <div>
                        <label>Amount</label>
                        <input id="inputAmount" type="number" placeholder="0" />
                    </div>
                    <div>
                        <label>Type</label>
                        <select id="inputType">
                            <option>Fixed</option>
                            <option>Variable</option>
                        </select>
                    </div>
                    <div>
                        <label>Category</label>
                        <select id="inputCategory">
                            <option>Rent</option>
                            <option>Food</option>
                            <option>Fun</option>
                            <option>Travel</option>
                            <option>Subscriptions</option>
                            <option>Bills</option>
                            <option>Saved</option>
                            <option>Other</option>
                        </select>
                    </div>
                </div>
                
                <button id="addBtn" class="btn-primary" onclick="addExpense()">+ Add Expense</button>
            </div>
        </div>

        <div id="expenses" class="tab-content hidden">
            <div class="table-container">
                <div class="expenses-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th style="width:120px;">Date</th>
                                <th>Name</th>
                                <th style="width:90px;">Amount</th>
                                <th style="width:80px;">Type</th>
                                <th style="width:100px;">Category</th>
                                <th style="width:30px;"></th>
                            </tr>
                        </thead>
                        <tbody id="expenseTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="charts" class="tab-content hidden">
            <div class="dashboard-grid">
                <div class="kpi-card bg-pink">
                    <h4>Income</h4>
                    <strong id="kIncome">0</strong>
                </div>
                <div class="kpi-card bg-green">
                    <h4>Expenses</h4>
                    <strong id="kExpenses">0</strong>
                </div>
                <div class="kpi-card bg-pink">
                    <h4>Saved</h4>
                    <strong id="kSaved">0</strong>
                </div>
            </div>

            <div class="charts-area">
                <div class="chart-wrapper-pie">
                    <canvas id="pieChart"></canvas>
                </div>
                <div class="chart-wrapper-line">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>
        </div>

    </div>

    <div class="sidebar-card">
        <h3 style="margin-top:0; margin-bottom:16px; font-size:16px;">Monthly Summary</h3>
        
        <div class="sidebar-section">
            <div class="summary-item sum-green">
                <span>Income</span>
                <span id="sIncome">0</span>
            </div>
            <div class="summary-item sum-pink">
                <span>Expenses</span>
                <span id="sExpenses">0</span>
            </div>
            <div class="summary-item sum-green">
                <span>Saved</span>
                <span id="sSaved">0</span>
            </div>
        </div>

        <div class="progress-group">
            <div class="progress-header">
                <span>Income Usage</span>
                <span id="incomeUsageText">0%</span>
            </div>
            <div class="progress-track">
                <div id="incomeBar" class="progress-fill" style="background:var(--matcha); width:0%"></div>
            </div>
        </div>

        <div class="progress-group">
            <div class="progress-header">
                <span>Savings Goal</span>
                <span id="goalText">0%</span>
            </div>
            <div class="progress-track">
                <div id="saveBar" class="progress-fill" style="background:var(--strawberry); width:0%"></div>
            </div>
        </div>

        <div class="remaining-card">
            <p>Remaining this month</p>
            <strong id="remaining">0</strong>
        </div>

        <button class="btn-export" onclick="exportCSV()">Export CSV</button>
    </div>

  </div>
</div>

<script>
// ==========================================
// CONFIG: DYNAMIC PANTRY ID
// ==========================================
const BASKET_NAME = "expenseTracker"; // We use one generic basket name, but separate IDs
let userPantryId = localStorage.getItem("userPantryId"); // Load saved ID

let fullData = {}; 
let settings = { currency: "kr" };
let currentMonth = new Date().toISOString().slice(0,7);
let saveTimeout;

// -- SETUP LOGIC --

function initApp() {
    initMonths();
    
    if(!userPantryId) {
        // No ID found? Show Setup Screen
        document.getElementById('setupScreen').classList.remove('hidden');
    } else {
        // ID found? Start loading
        loadData();
    }
}

function savePantryId() {
    const input = document.getElementById('pantryIdInput').value.trim();
    if(input.length < 5) {
        alert("Please enter a valid Pantry ID.");
        return;
    }
    userPantryId = input;
    localStorage.setItem("userPantryId", userPantryId);
    document.getElementById('setupScreen').classList.add('hidden');
    loadData();
}

function openSetup() {
    if(confirm("Do you want to change your Cloud ID? This will switch to a different budget.")) {
        document.getElementById('pantryIdInput').value = userPantryId || "";
        document.getElementById('setupScreen').classList.remove('hidden');
    }
}

// -- SYNC LOGIC --

function setStatus(state, msg) {
    const dot = document.getElementById('statusDot');
    const txt = document.getElementById('statusText');
    if(state === 'loading') {
        dot.className = "status-dot status-yellow";
        txt.textContent = "Syncing";
    } else if (state === 'saved') {
        dot.className = "status-dot status-green";
        txt.textContent = "Synced";
    } else if (state === 'error') {
        dot.className = "status-dot status-red";
        txt.textContent = msg || "Error";
    }
}

async function loadData() {
    document.getElementById('loadingOverlay').classList.remove('hidden');
    setStatus('loading');
